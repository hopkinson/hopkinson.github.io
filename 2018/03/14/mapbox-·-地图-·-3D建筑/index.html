<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="hopkinson"><meta name="description" content="广州·前端"><link rel="alternative" href="/atom.xml" title="何大小成" type="application/atom+xml"><link rel="icon" href="/logo.png"><title> 地图 · 轮廓数据 · geojson - 何大小成</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">何大小成</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">唱遊→</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-03-14T01:00:51.000Z">March 14, 2018</time><h1 class="post__title"><a href="/2018/03/14/mapbox-·-地图-·-3D建筑/"> 地图 · 轮廓数据 · geojson</a></h1><div class="post__main echo"><p>最近刚开始在着手一个南沙区的可视化项目，希望在地图上显示3D建筑，而且还支持自定义建筑。当时看了百度Echarts的几个例子，发现实现这个功能有好几个方法，而我就选择了其中之一：</p>
<ol>
<li>从高德地图爬虫获取建筑轮廓，生成geojson文件</li>
<li>mapbox定制自定义地图</li>
<li>echarts-gl生成</li>
</ol>
<p>我认为关键一步还是如何获取数据，实现了这一步基本上都解决了渲染问题。</p>
<blockquote>
<p>本文着重讲解如何从高德地图爬虫获取建筑轮廓，生成geojson文件</p>
</blockquote>
<p><img src="http://ol02dlpzm.bkt.clouddn.com/981f406bb191181d11a3e36d7feeaf99.png?imageView2/1/w/200/h/100" alt="map"></p>
<h3 id="geojson"><a href="#geojson" class="headerlink" title="geojson"></a>geojson</h3><p>GeoJson是用于描述地理空间信息的数据格式。它不是一种新的数据格式，只是语法规则符合JSON格式，专门用于表示地理信息。（具体这里就不做详细讲解）</p>
<p><a href="http://geojson.io/#map=2/20.0/0.0" target="_blank" rel="noopener">geojson.io</a>可以手动制作GeoJson文件。利用网站给我们提供的工具可以自由绘制轮廓。绘制完给property填上height属性，在echarts就能知道建筑物高度.</p>
<p><img src="http://ol02dlpzm.bkt.clouddn.com/1.gif.gif?imageView2/0/w/400" alt="map"></p>
<p>但是手动绘制建筑轮廓和高度比较烦，另外还要知道经纬度。所以才采用从高德地图爬虫。</p>
<h3 id="高德地图爬建筑轮廓"><a href="#高德地图爬建筑轮廓" class="headerlink" title="高德地图爬建筑轮廓"></a>高德地图爬建筑轮廓</h3><p>爬虫不要经常去尝试与测试，<strong>小心被封IP</strong>。</p>
<p>思路就是：<strong>通过搜索，将接口返回的数据然后拼成geojson格式,然后写入文件即可。</strong></p>
<ol>
<li>搜索<br>搜索意思是在网页搜索框输入地方，建筑范围比较大有轮廓数据，一些小吃店只有坐标，而不存在轮廓数据。以星河丹堤小区为例，蓝色部分就是我们想要的轮廓。</li>
</ol>
<p><img src="http://ol02dlpzm.bkt.clouddn.com/xinghedandi.gif?imageView2/0/w/400" alt=""></p>
<p>接口（poiInfo）返回的数据格式就是：</p>
<p><img src="http://ol02dlpzm.bkt.clouddn.com/dc88f9838e12a5f5a8d32ac93bc5a2c8.png?imageView2/0/w/400" alt=""></p>
<p>我们是程序员，不可能收集数据都用这种方法来只做geojson文件，所以最好自己写一段node程序来实现，实现获取南沙区的小区，公园等轮廓数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>)</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">let</span> arr = []</span><br><span class="line"><span class="keyword">let</span> arrRoad = []</span><br><span class="line"><span class="comment">// 搜索的范围</span></span><br><span class="line"><span class="keyword">let</span> search = [</span><br><span class="line">  <span class="string">'小区'</span>,</span><br><span class="line">  <span class="string">'公园'</span>,</span><br><span class="line">  <span class="string">'医院'</span>,</span><br><span class="line">  <span class="string">'广场'</span>,</span><br><span class="line">  <span class="string">'写字楼'</span></span><br><span class="line">]</span><br><span class="line"><span class="comment">// 搜索的地区</span></span><br><span class="line"><span class="keyword">let</span> district = <span class="string">'南沙区 '</span></span><br><span class="line"><span class="keyword">let</span> LENGTH = <span class="number">0.001</span></span><br><span class="line"><span class="keyword">let</span> url = <span class="string">'http://ditu.amap.com/service/poiInfo?query_type=TQUERY&amp;pagesize=20&amp;pagenum=1&amp;qii=true&amp;cluster_state=5&amp;need_utd=true&amp;utd_sceneid=1000&amp;div=PC1000&amp;addr_poi_merge=true&amp;is_classify=true&amp;zoom=17&amp;city=440100&amp;geoobj=113.605673%7C22.748379%7C113.621122%7C22.752178&amp;keywords='</span></span><br><span class="line">search.forEach(<span class="function"><span class="params">keyword</span> =&gt;</span> &#123;</span><br><span class="line">  arr.push(<span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    request(<span class="function">(<span class="params">url + <span class="built_in">encodeURI</span>(district + keyword</span>)), (<span class="params">error, response, body</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!error &amp;&amp; response.statusCode === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(body)</span><br><span class="line">        <span class="keyword">let</span> transBody = body &amp;&amp; <span class="built_in">JSON</span>.parse(body)</span><br><span class="line">        <span class="keyword">let</span> &#123;data&#125; = transBody</span><br><span class="line">        <span class="keyword">let</span> &#123;poi_list&#125; = data</span><br><span class="line">        <span class="comment">// 轮廓规则：</span></span><br><span class="line">        <span class="comment">// 1. 如果有轮廓数据，则按返回的数据为准</span></span><br><span class="line">        <span class="comment">// 2. 如果没有轮廓数据，则以经纬度为中心，生成一个正方形</span></span><br><span class="line">        <span class="keyword">let</span> regionData = poi_list.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> hasAoi = item.domain_list.find(<span class="function"><span class="params">i</span> =&gt;</span> i.name === <span class="string">'aoi'</span>)</span><br><span class="line">          <span class="keyword">let</span> po1 = [</span><br><span class="line">            <span class="built_in">Number</span>(item.longitude) + LENGTH,</span><br><span class="line">            item.latitude</span><br><span class="line">          ]</span><br><span class="line">          <span class="keyword">let</span> po2 = [</span><br><span class="line">            item.longitude,</span><br><span class="line">            <span class="built_in">Number</span>(item.latitude) + LENGTH</span><br><span class="line">          ]</span><br><span class="line">          <span class="keyword">let</span> po3 = [</span><br><span class="line">            <span class="built_in">Number</span>(item.longitude) - LENGTH,</span><br><span class="line">            item.latitude</span><br><span class="line">          ]</span><br><span class="line">          <span class="keyword">let</span> po4 = [</span><br><span class="line">            item.longitude,</span><br><span class="line">            <span class="built_in">Number</span>(item.latitude) - LENGTH</span><br><span class="line">          ]</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            name: item.name,</span><br><span class="line">            coordinates: hasAoi.hasOwnProperty(<span class="string">'value'</span>)</span><br><span class="line">              ? [hasAoi.value.split(<span class="string">'_'</span>).map(<span class="function"><span class="params">i</span> =&gt;</span> i.split(<span class="string">','</span>))]</span><br><span class="line">              : [</span><br><span class="line">                [po1, po2, po3, po4, po1]</span><br><span class="line">              ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 按照Geojson，高度先固定为10</span></span><br><span class="line">        <span class="keyword">let</span> result = regionData.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">'type'</span>: <span class="string">'Feature'</span>,</span><br><span class="line">            <span class="string">'properties'</span>: &#123;</span><br><span class="line">              <span class="string">'stroke'</span>: <span class="string">'#555555'</span>,</span><br><span class="line">              <span class="string">'stroke-width'</span>: <span class="number">2</span>,</span><br><span class="line">              <span class="string">'stroke-opacity'</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="string">'fill'</span>: <span class="string">'#555555'</span>,</span><br><span class="line">              <span class="string">'fill-opacity'</span>: <span class="number">0.5</span>,</span><br><span class="line">              <span class="string">'height'</span>: <span class="number">10</span>,</span><br><span class="line">              <span class="string">'name'</span>: item.name</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'geometry'</span>: &#123;</span><br><span class="line">              <span class="string">'type'</span>: <span class="string">'Polygon'</span>,</span><br><span class="line">              <span class="string">'coordinates'</span>: item.coordinates</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        resolve(result)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">Promise</span>.all(arr).then(<span class="function"><span class="params">urls</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> geoJSON = &#123;&#125;</span><br><span class="line">  geoJSON.type = <span class="string">'FeatureCollection'</span></span><br><span class="line">  geoJSON.features = [].concat(...urls)</span><br><span class="line">  <span class="comment">// 写入map.geojson文件</span></span><br><span class="line">  fs.unlink(__dirname + <span class="string">'/map.geojson'</span>, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    fs.writeFile(__dirname + <span class="string">'/map.geojson'</span>, <span class="built_in">JSON</span>.stringify(geoJSON), &#123;</span><br><span class="line">      flag: <span class="string">'a'</span></span><br><span class="line">    &#125;, err =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(err)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'写入成功'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/地图/">地图</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC8zNDU0Ni8xMTA4NA=="><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2018 hopkinson</div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-115092889-1');
ga('send','pageview');</script><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>