<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="hopkinson"><meta name="description" content="广州·前端"><link rel="alternative" href="/atom.xml" title="何大小成" type="application/atom+xml"><link rel="icon" href="/logo.png"><title>D3 · 地图 · 可视化 - 何大小成</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">何大小成</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/archives">唱遊→</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"> <time class="post__time" datetime="2018-03-20T01:52:50.000Z">March 20, 2018</time><h1 class="post__title"><a href="/2018/03/20/D3-·-地图-·-可视化/">D3 · 地图 · 可视化</a></h1><div class="post__main echo"><p>最近都在学习D3和地图结合的东西，作为知识储备。于是自己就搞了一些小小栗子作为分享，很简单，所以高手可以略过啦哈哈。</p>
<p><strong>需求： 通过一组json数据（比如是中国旅游业产值的数据（虚构）），我要把这些数据在地图上可视化显示，产值比较低的用浅颜色表示，产值高的则用深颜色表示。</strong></p>
<p>实现的效果：<br><img src="http://ol02dlpzm.bkt.clouddn.com/845cc9d44a69d78a78f1ee19b647f845.png?imageView2/0/w/200" alt=""></p>
<h2 id="TopoJSON-amp-GeoJSON-关系"><a href="#TopoJSON-amp-GeoJSON-关系" class="headerlink" title="TopoJSON &amp; GeoJSON 关系"></a>TopoJSON &amp; GeoJSON 关系</h2><p>TopoJSON是GeoJSON按拓扑学编码后的扩展形式，相比GeoJSON直接使用Polygon之类的几何体来表示图形的方法，TopoJSON中每个几何体都是将共享边(arcs)整合而成的。<br>对比一下<br>TopoJSON：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"Topology"</span>,</span><br><span class="line">  <span class="string">"transform"</span>: &#123;</span><br><span class="line">    <span class="string">"scale"</span>: [<span class="number">0.0023415374016230355</span>, <span class="number">0.0018039985796827979</span>],</span><br><span class="line">    <span class="string">"translate"</span>: [<span class="number">73.60225630700012</span>, <span class="number">18.19318268400005</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"objects"</span>: &#123;</span><br><span class="line">    <span class="string">"china"</span>: &#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"GeometryCollection"</span>,</span><br><span class="line">      <span class="string">"geometries"</span>: [&#123;</span><br><span class="line">        <span class="string">"arcs"</span>: [</span><br><span class="line">          [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Polygon"</span>,</span><br><span class="line">        <span class="string">"properties"</span>: &#123;</span><br><span class="line">          <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="string">"name"</span>: <span class="string">"甘肃"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GeoJSON:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"FeatureCollection"</span>,</span><br><span class="line">  <span class="string">"features"</span>: [&#123;</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"Feature"</span>,</span><br><span class="line">      <span class="string">"properties"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"甘肃"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"geometry"</span>: &#123;</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"Polygon"</span>,</span><br><span class="line">        <span class="string">"coordinates"</span>: [</span><br><span class="line">          [</span><br><span class="line">            [<span class="number">104.35851932200904</span>, <span class="number">37.40123159456249</span>],</span><br><span class="line">            [<span class="number">104.46450768428224</span>, <span class="number">37.440247301072134</span>],</span><br><span class="line">            [<span class="number">104.68950687084538</span>, <span class="number">37.41192861571304</span>]</span><br><span class="line">            ...(省略)</span><br><span class="line">          ]</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>用TopoJSON最大优点：文件缩小了80%，消除了冗余，也就是说TopoJSON只相当于GeoJSON的20大小。</p>
<blockquote>
<p>D3的应用中尽可能使用TopoJSON。</p>
</blockquote>
<p><strong> 所以在我们项目里，中国边界使用了TopoJSON格式的数据。</strong></p>
<h2 id="产值数据"><a href="#产值数据" class="headerlink" title="产值数据"></a>产值数据</h2><p>这一部分数据虽然是虚构，但是这一部分就是我们平时从接口调用得来的数据。<br>部分内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"中国"</span>,</span><br><span class="line">	<span class="string">"provinces"</span>:</span><br><span class="line">	[</span><br><span class="line">		&#123;<span class="string">"name"</span>: <span class="string">"北京"</span>, <span class="string">"value"</span>:	<span class="number">14149</span>    &#125;,</span><br><span class="line">		&#123;<span class="string">"name"</span>: <span class="string">"天津"</span>, <span class="string">"value"</span>:	<span class="number">2226.41</span>&#125;</span><br><span class="line">  ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>provinces就是每一个省份的值，name是省份名称，value是旅游业产值。</p>
<h2 id="构建地图"><a href="#构建地图" class="headerlink" title="构建地图"></a>构建地图</h2><p>重点来了。</p>
<h4 id="d3-json请求数据"><a href="#d3-json请求数据" class="headerlink" title="d3.json请求数据"></a>d3.json请求数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d3.json(<span class="string">"tourism.json"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error, valuedata</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// valuedata 就是读取到的数据</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="重组数据"><a href="#重组数据" class="headerlink" title="重组数据"></a>重组数据</h4><p>将读取到的数据存到数组values，令其索引号为各省的名称。这里的作用就是：当我们为各省份填充色的时候可以循环读取。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> values = &#123;&#125;;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;valuedata.provinces.length; i++)&#123;</span><br><span class="line">  <span class="keyword">var</span> name = valuedata.provinces[i].name;</span><br><span class="line">  <span class="keyword">var</span> value = valuedata.provinces[i].value;</span><br><span class="line">  values[name] = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(values)</span><br><span class="line"><span class="comment">// &#123;北京: 14149, 天津: 2226.41, 河北: 1544.94&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="设定比例尺"><a href="#设定比例尺" class="headerlink" title="设定比例尺"></a>设定比例尺</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//求产值的最大值和最小值，并作为比例尺定义域的最大值&amp;最小值</span></span><br><span class="line"><span class="keyword">var</span> maxvalue = d3.max(valuedata.provinces, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>)</span>&#123; <span class="keyword">return</span> d.value; &#125;);</span><br><span class="line"><span class="keyword">var</span> minvalue = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//定义一个线性比例尺，将最小值和最大值之间的值映射到[0, 1]</span></span><br><span class="line"><span class="keyword">var</span> linear = d3.scale.linear()</span><br><span class="line">            .domain([minvalue, maxvalue])</span><br><span class="line">            .range([<span class="number">0</span>, <span class="number">0.5</span>]);</span><br></pre></td></tr></table></figure>
<h4 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h4><p>颜色插值函数以浅蓝色和深蓝色为边界，也就是说，省份的旅游产业值越大，蓝色越深。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义最小值和最大值对应的颜色</span></span><br><span class="line"><span class="keyword">var</span> a = d3.rgb(<span class="number">0</span>,<span class="number">255</span>,<span class="number">255</span>);	<span class="comment">//浅蓝色</span></span><br><span class="line"><span class="keyword">var</span> b = d3.rgb(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>);	<span class="comment">//蓝色</span></span><br><span class="line"><span class="comment">//颜色插值函数</span></span><br><span class="line"><span class="keyword">var</span> computeColor = d3.interpolate(a,b);</span><br></pre></td></tr></table></figure>
<h4 id="设定省份颜色"><a href="#设定省份颜色" class="headerlink" title="设定省份颜色"></a>设定省份颜色</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">provinces.style(<span class="string">"fill"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d,i</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> t = linear( values[d.properties.name] );</span><br><span class="line">  <span class="keyword">var</span> color = computeColor(t);</span><br><span class="line">  <span class="keyword">return</span> color.toString();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>到了这里，我们得到这样的地图：<br><img src="http://ol02dlpzm.bkt.clouddn.com/1e785206803ea77d4f3f6d67d0194793.png?imageView2/0/w/200" alt=""></p>
<h4 id="标识"><a href="#标识" class="headerlink" title="标识"></a>标识</h4><p>虽然我们知道颜色越深产值越高，但是用户不知道。所以，我们缺少了一个什么颜色对应什么数值的一个标识。可以采用：左下角添加一个矩形，颜色渐变，然后再加对应的数值。</p>
<p>svg渐变中渐变是<code>&lt;defs&gt;</code>和<code>&lt;linearGradient&gt;</code>结合。这里不做详细介绍，举个例子：<br>1. 定义在<defs>，给渐变定义id号。</defs></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">defs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">linearGradient</span> <span class="attr">id</span>=<span class="string">"svg"</span> <span class="attr">x1</span>=<span class="string">"0%"</span> <span class="attr">y1</span>=<span class="string">"0%"</span> <span class="attr">x2</span>=<span class="string">"100%"</span> <span class="attr">y2</span>=<span class="string">"0%"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">stop</span> <span class="attr">offset</span>=<span class="string">"0"</span> <span class="attr">stop-color</span>=<span class="string">"#f00"</span>&gt;</span><span class="tag">&lt;/<span class="name">stop</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">stop</span> <span class="attr">offset</span>=<span class="string">"100%"</span> <span class="attr">stop-color</span>=<span class="string">"#000"</span>&gt;</span><span class="tag">&lt;/<span class="name">stop</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">linearGradient</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol>
<li>使用</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">"400"</span> <span class="attr">height</span>=<span class="string">"399"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">rect</span> <span class="attr">fill</span>=<span class="string">"url(#svg)"</span> <span class="attr">x</span>=<span class="string">"10"</span> <span class="attr">y</span>=<span class="string">"10"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>那么用D3代码定义一个线性渐变如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个线性渐变</span></span><br><span class="line"><span class="keyword">var</span> defs = svg.append(<span class="string">"defs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> linearGradient = defs.append(<span class="string">"linearGradient"</span>)</span><br><span class="line">            .attr(<span class="string">"id"</span>,<span class="string">"linearColor"</span>)</span><br><span class="line">            .attr(<span class="string">"x1"</span>,<span class="string">"0%"</span>)</span><br><span class="line">            .attr(<span class="string">"y1"</span>,<span class="string">"0%"</span>)</span><br><span class="line">            .attr(<span class="string">"x2"</span>,<span class="string">"100%"</span>)</span><br><span class="line">            .attr(<span class="string">"y2"</span>,<span class="string">"0%"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stop1 = linearGradient.append(<span class="string">"stop"</span>)</span><br><span class="line">        .attr(<span class="string">"offset"</span>,<span class="string">"0%"</span>)</span><br><span class="line">        .style(<span class="string">"stop-color"</span>,a.toString());</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stop2 = linearGradient.append(<span class="string">"stop"</span>)</span><br><span class="line">        .attr(<span class="string">"offset"</span>,<span class="string">"100%"</span>)</span><br><span class="line">        .style(<span class="string">"stop-color"</span>,b.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">//添加一个矩形，并应用线性渐变</span></span><br><span class="line"><span class="keyword">var</span> colorRect = svg.append(<span class="string">"rect"</span>)</span><br><span class="line">      .attr(<span class="string">"x"</span>, <span class="number">20</span>)</span><br><span class="line">      .attr(<span class="string">"y"</span>, <span class="number">490</span>)</span><br><span class="line">      .attr(<span class="string">"width"</span>, <span class="number">140</span>)</span><br><span class="line">      .attr(<span class="string">"height"</span>, <span class="number">30</span>)</span><br><span class="line">      .style(<span class="string">"fill"</span>,<span class="string">"url(#"</span> + linearGradient.attr(<span class="string">"id"</span>) + <span class="string">")"</span>);</span><br></pre></td></tr></table></figure></p>
<p>最后，在举行在添加文字：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加文字</span></span><br><span class="line"><span class="keyword">var</span> minValueText = svg.append(<span class="string">"text"</span>)</span><br><span class="line">      .attr(<span class="string">"x"</span>, <span class="number">20</span>)</span><br><span class="line">      .attr(<span class="string">"y"</span>, <span class="number">490</span>)</span><br><span class="line">      .attr(<span class="string">"dy"</span>, <span class="string">"-0.3em"</span>)</span><br><span class="line">      .text(<span class="function"><span class="params">()</span> =&gt;</span> minvalue);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> maxValueText = svg.append(<span class="string">"text"</span>)</span><br><span class="line">      .attr(<span class="string">"x"</span>, <span class="number">160</span>)</span><br><span class="line">      .attr(<span class="string">"y"</span>, <span class="number">490</span>)</span><br><span class="line">      .attr(<span class="string">"dy"</span>, <span class="string">"-0.3em"</span>)</span><br><span class="line">      .text(<span class="function"><span class="params">()</span>=&gt;</span> maxvalue);</span><br></pre></td></tr></table></figure></p>
<p>最后把代码整理：</p>
<p></p><p data-height="265" data-theme-id="0" data-slug-hash="rdjGpO" data-default-tab="js" data-user="hopkinson" data-embed-version="2" data-pen-title="d3-map" class="codepen">See the Pen <a href="https://codepen.io/hopkinson/pen/rdjGpO/" target="_blank" rel="noopener">d3-map</a> by 何大小成 (<a href="https://codepen.io/hopkinson" target="_blank" rel="noopener">@hopkinson</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.</p><p></p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>
</div></header><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a class="post__tag__link" href="/tags/D3/">D3</a></li><li class="post__tag__item"><a class="post__tag__link" href="/tags/地图/">地图</a></li></ul></footer></article><div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC8zNDU0Ni8xMTA4NA=="><script>(function(d, s) {var j, e = d.getElementsByTagName(s)[0];if (typeof LivereTower === 'function') { return; } j = d.createElement(s);j.src = 'https://cdn-city.livere.com/js/embed.dist.js';j.async = true;e.parentNode.insertBefore(j, e);})(document, 'script');</script></div></main><footer class="foot"><div class="foot-copy">&copy; 2018 hopkinson</div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-115092889-1');
ga('send','pageview');</script><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>